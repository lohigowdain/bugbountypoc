<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bug Hunters - Security Vulnerability Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.recaptchaLoaded = false;
        window.onRecaptchaError = function() {
            console.error('reCAPTCHA failed to load');
            document.getElementById('loadingIndicator').innerHTML = 
                '<div class="text-red-600">reCAPTCHA failed to load. Please check your internet connection.</div>';
        };
    </script>
    <script src="https://www.google.com/recaptcha/api.js?render=6LfSaKoqAAAAAPBwrzOqoXWzih0b1hUT2z_j48Hr" 
            onload="window.recaptchaLoaded = true;" 
            onerror="window.onRecaptchaError()">
    </script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8">Bug Hunters Platform</h1>
        <div id="securityBugReport"></div>
        <div id="loadingIndicator" class="text-center text-gray-600">
            Loading form...
        </div>
    </div>

    <script>
        const RECAPTCHA_SITE_KEY = '6LfSaKoqAAAAAPBwrzOqoXWzih0b1hUT2z_j48Hr';
        const API_ENDPOINT = 'https://3beyl53jrj.execute-api.us-east-1.amazonaws.com/prod/bug-report';

        async function waitForRecaptcha(timeout = 5000) {
            const start = Date.now();
            while (!window.recaptchaLoaded && Date.now() - start < timeout) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            if (!window.recaptchaLoaded) {
                throw new Error('reCAPTCHA failed to load');
            }
        }

        async function loadBugReportForm() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            try {
                loadingIndicator.style.display = 'block';
                
                await waitForRecaptcha();
                
                await new Promise(resolve => grecaptcha.ready(resolve));
                const token = await grecaptcha.execute(RECAPTCHA_SITE_KEY, {action: 'load_form'});
                
                const response = await fetch(API_ENDPOINT, {
                    method: 'GET',
                    headers: {
                        'x-recaptcha-token': token
                    },
                    mode: 'cors'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const html = await response.text();
                document.getElementById('securityBugReport').innerHTML = html;
                loadingIndicator.style.display = 'none';

                // Add form submission handler
                const form = document.getElementById('bugReportForm');
                if (form) {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        const submitToken = await new Promise((resolve) => {
                            grecaptcha.ready(() => {
                                grecaptcha.execute(RECAPTCHA_SITE_KEY, {action: 'submit_form'})
                                    .then(resolve);
                            });
                        });

                        const formData = new FormData(form);
                        const data = Object.fromEntries(formData);

                        try {
                            const submitResponse = await fetch(API_ENDPOINT, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'x-recaptcha-token': submitToken
                                },
                                mode: 'cors',
                                body: JSON.stringify(data)
                            });

                            if (!submitResponse.ok) {
                                throw new Error('Submission failed');
                            }

                            alert('Report submitted successfully!');
                            form.reset();
                        } catch (error) {
                            console.error('Submission error:', error);
                            alert('Failed to submit report. Please try again.');
                        }
                    });
                }
            } catch (error) {
                console.error('Error:', error);
                loadingIndicator.style.display = 'none';
                document.getElementById('securityBugReport').innerHTML = 
                    `<div class="text-red-600 text-center">
                        ${error.message}. Please refresh the page to try again.
                    </div>`;
            }
        }

        document.addEventListener('DOMContentLoaded', loadBugReportForm);
    </script>
</body>
</html> 
